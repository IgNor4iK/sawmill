<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Журнал смены</title>
    <script src="telega.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --accent: #4CD964; --text: #ffffff; --text-dim: #888; --danger: #FF3B30; --input-bg: #262626; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        
        .header { display: flex; align-items: center; margin-bottom: 15px; }
        .back-btn { font-size: 34px; color: var(--accent); cursor: pointer; padding-right: 15px; line-height: 1; }
        
        .card { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #222; }
        .stats-line { text-align: center; font-size: 14px; font-weight: bold; color: var(--accent); margin-bottom: 15px; background: rgba(76, 217, 100, 0.1); padding: 8px; border-radius: 10px; }
        
        label { display: block; margin-bottom: 6px; font-size: 11px; color: #666; text-transform: uppercase; }
        input { width: 100%; padding: 12px; margin-bottom: 12px; background: var(--input-bg); border: 1px solid #333; border-radius: 10px; color: white; font-size: 18px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }

        .add-btn-log { width: 100%; padding: 16px; background: var(--accent); color: #000; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.1s; }
        .add-btn-log:active { transform: scale(0.98); opacity: 0.9; }

        .log-item { background: var(--card); padding: 12px; margin-top: 8px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--accent); border: 1px solid #222; border-left: 5px solid var(--accent); }
        .log-desc { font-size: 17px; font-weight: bold; }
        .log-meta { font-size: 11px; color: #555; }
        .del-log { color: var(--danger); font-size: 24px; padding: 0 10px; cursor: pointer; opacity: 0.5; }

        .clear-link { color: #444; font-size: 11px; cursor: pointer; text-align: center; display: block; margin-top: 20px; text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <div class="back-btn" onclick="window.history.back()">‹</div>
        <h2 style="margin:0">Журнал</h2>
    </div>

    <div class="stats-line" id="stats-summary">0 шт. | 0.000 м³</div>

    <div class="card">
        <div style="display: flex; gap: 10px;">
            <div style="flex:2"><label>Диаметр (мм)</label><input type="number" id="log-size" placeholder="240" pattern="\[0-9]*" inputmode="numeric"></div>
            <div style="flex:1"><label>Длина (м)</label><input type="number" id="log-len" value="6.0" step="0.1"></div>
        </div>
        <label>Заметка</label><input type="text" id="log-note" placeholder="Сорт 1, береза...">
        <button class="add-btn-log" onclick="addToJournal()">ЗАПИСАТЬ БРЕВНО</button>
    </div>

    <div id="journal-list"></div>
    <span onclick="clearJournal()" class="clear-link">Сбросить данные смены</span>

    <script>
        const tg = window.Telegram.WebApp;
        const LOG_KEY = 'sawmill_journal_v4';
        
        // Твоя таблица ГОСТ
        const GOST_REF = { 14:[0.06,0.09,0.12,0.15], 16:[0.07,0.11,0.16,0.19], 18:[0.10,0.14,0.19,0.24], 20:[0.12,0.17,0.23,0.30], 22:[0.15,0.21,0.28,0.36], 24:[0.18,0.25,0.33,0.43], 26:[0.21,0.29,0.39,0.50], 28:[0.25,0.34,0.45,0.58], 30:[0.28,0.39,0.52,0.67], 32:[0.33,0.45,0.59,0.76], 34:[0.37,0.51,0.66,0.85], 36:[0.41,0.57,0.74,0.95], 38:[0.46,0.63,0.83,1.06], 40:[0.51,0.70,0.92,1.17] };

        function calculateGost(diamMm, lenM) {
            let d = Math.round(diamMm / 10);
            if (d < 14) return (Math.PI * Math.pow(diamMm/2000, 2) * lenM).toFixed(3);
            let ds = Object.keys(GOST_REF).map(Number).sort((a,b)=>a-b);
            let dL = ds.filter(x => x <= d).pop() || ds[0];
            let dU = ds.filter(x => x >= d).shift() || ds[ds.length-1];
            
            const getV = (dm, ln) => { 
                let vs = GOST_REF[dm]; 
                return ln <= 3.5 ? vs[0] : ln <= 4.5 ? vs[1] : ln <= 5.5 ? vs[2] : vs[3]; 
            };

            if (dL === dU) return getV(d, lenM).toFixed(3);
            let v1 = getV(dL, lenM), v2 = getV(dU, lenM);
            return (v1 + (v2 - v1) * (d - dL) / (dU - dL)).toFixed(3);
        }

        function addToJournal() {
            const s = document.getElementById('log-size');
            const l = document.getElementById('log-len');
            const n = document.getElementById('log-note');
            
            if (!s.value) return;

            const vol = calculateGost(parseFloat(s.value), parseFloat(l.value));
            let logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
            
            logs.unshift({ 
                id: Date.now(), 
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 
                size: s.value, 
                len: l.value, 
                vol: vol, 
                note: n.value || "" 
            });

            localStorage.setItem(LOG_KEY, JSON.stringify(logs));
            tg.HapticFeedback?.notificationOccurred('success');
            
            s.value = ''; 
            n.value = ''; 
            s.focus(); 
            loadJournal();
        }

        function loadJournal() {
            const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
            const totalVol = logs.reduce((sum, item) => sum + parseFloat(item.vol), 0).toFixed(3);
            document.getElementById('stats-summary').innerText = `${logs.length} шт. | ${totalVol} м³`;
            
            document.getElementById('journal-list').innerHTML = logs.map(item => `
                <div class="log-item">
                    <div>
                        <div class="log-meta">${item.time} • ${item.len}м</div>
                        <div class="log-desc">${item.size} мм <span style="color:var(--accent); margin-left:8px;">${item.vol} м³</span></div>
                        <div style="font-size:12px; color:#555;">${item.note}</div>
                    </div>
                    <div class="del-log" onclick="deleteLog(${item.id})">×</div>
                </div>`).join('');
        }

        function deleteLog(id) {
            if (confirm("Удалить запись?")) {
                let logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]").filter(l => l.id !== id);
                localStorage.setItem(LOG_KEY, JSON.stringify(logs));
                loadJournal();
            }
        }

        function clearJournal() {
            if (confirm("Очистить весь журнал за сегодня?")) {
                localStorage.removeItem(LOG_KEY);
                loadJournal();
            }
        }

        window.onload = () => {
            tg.ready();
            // Подхват из калькулятора
            const tmp = localStorage.getItem('tmp_size');
            if(tmp) { 
                document.getElementById('log-size').value = tmp; 
                localStorage.removeItem('tmp_size'); 
            }
            loadJournal();
        };
    </script>
</body>
</html>
