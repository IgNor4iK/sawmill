<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Метки</title>
    <!-- Подключаем ту же библиотеку -->
    <script src="telega.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --accent: #007AFF; --text: #ffffff; --input-bg: #262626; --danger: #FF3B30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
        
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { font-size: 34px; color: var(--accent); cursor: pointer; padding-right: 15px; line-height: 1; }
        
        .card { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #222; }
        label { display: block; margin-bottom: 6px; font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input { width: 100%; padding: 12px; margin-bottom: 12px; background: var(--input-bg); border: 1px solid #333; border-radius: 10px; color: white; font-size: 18px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }

        .row-group { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; background: #222; padding: 10px; border-radius: 12px; }
        .del-btn { background: none; border: none; color: var(--danger); font-size: 28px; cursor: pointer; padding: 0 10px; }
        
        .btn-add { background: #333; color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; font-size: 14px; }
        
        .result-item { 
            background: var(--card); padding: 16px; margin-top: 10px; border-radius: 14px; 
            font-size: 24px; display: flex; justify-content: space-between; align-items: center;
            font-weight: 800; border-left: 6px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .result-item:active { transform: scale(0.98); background: #222; }
        .res-info { font-size: 12px; color: #666; font-weight: normal; }

        .clear-link { color: #555; font-size: 12px; cursor: pointer; text-align: center; display: block; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="back-btn" onclick="tg.close()">‹</div>
        <h2 style="margin:0">Метки пропила</h2>
    </div>

    <div class="card">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>Высота (мм)</label><input type="number" id="h" value="250" oninput="saveAndCalc()"></div>
            <div><label>Пила (мм)</label><input type="number" id="kerf" value="3" oninput="saveAndCalc()"></div>
        </div>
        <label>Основание (мм)</label>
        <input type="number" id="base" value="50" oninput="saveAndCalc()">
    </div>

    <div class="card">
        <div id="rows-container"></div>
        <button class="btn-add" onclick="addRow(25, 1, true)">+ ДОБАВИТЬ РАЗМЕР</button>
    </div>

    <div id="results"></div>
    <span onclick="clearCalc()" class="clear-link">Сбросить всё</span>

    <script>
        const tg = window.Telegram.WebApp;
        const CALC_KEY = 'sawmill_settings_v4';

        // Виброотклик
        function clickVibe() { tg.HapticFeedback?.impactOccurred('light'); }

        function addRow(t = 25, c = 1, save = true) {
            if(save) clickVibe();
            const div = document.createElement('div');
            div.className = 'row-group';
            div.innerHTML = `
                <div style="flex:2"><label>Толщина</label><input type="number" class="t-val" value="${t}" oninput="saveAndCalc()"></div>
                <div style="flex:1"><label>Кол-во</label><input type="number" class="c-val" value="${c}" oninput="saveAndCalc()"></div>
                <button class="del-btn" onclick="this.parentElement.remove(); saveAndCalc();">×</button>`;
            document.getElementById('rows-container').appendChild(div);
            if (save) saveAndCalc();
        }

        function saveAndCalc() {
            const data = {
                h: document.getElementById('h').value, 
                kerf: document.getElementById('kerf').value, 
                base: document.getElementById('base').value,
                rows: Array.from(document.querySelectorAll('.row-group')).map(g => ({ 
                    t: g.querySelector('.t-val').value, 
                    c: g.querySelector('.c-val').value 
                }))
            };
            localStorage.setItem(CALC_KEY, JSON.stringify(data));
            calculate();
        }

        function calculate() {
            const h_max = parseFloat(document.getElementById('h').value) || 0;
            const kerf = parseFloat(document.getElementById('kerf').value) || 0;
            const base = parseFloat(document.getElementById('base').value) || 0;
            
            let current_h = base;
            let marks = [];

            document.querySelectorAll('.row-group').forEach((row) => {
                let t = parseFloat(row.querySelector('.t-val').value) || 0;
                let c = parseInt(row.querySelector('.c-val').value) || 0;
                for (let j = 0; j < c; j++) {
                    if (current_h + t + kerf <= h_max) {
                        current_h += (t + kerf);
                        marks.push({ val: current_h.toFixed(1), size: t });
                    }
                }
            });

            document.getElementById('results').innerHTML = marks.slice().reverse().map((m, idx) => `
                <div class="result-item" onclick="toJournal(${m.val})">
                    <div class="res-info">МЕТКА №${marks.length - idx}<br>${m.size} мм</div>
                    <span>${m.val}</span>
                </div>`).join('');
        }

        function toJournal(val) {
            tg.HapticFeedback?.notificationOccurred('success');
            localStorage.setItem('tmp_size', Math.round(val));
            // Если есть страница журнала, переходим
            window.location.href = 'journal.html';
        }

        function clearCalc() {
            if (confirm("Сбросить все настройки?")) {
                localStorage.removeItem(CALC_KEY);
                location.reload();
            }
        }

        window.onload = () => {
            tg.ready();
            const saved = JSON.parse(localStorage.getItem(CALC_KEY));
            if (saved) {
                document.getElementById('h').value = saved.h;
                document.getElementById('kerf').value = saved.kerf;
                document.getElementById('base').value = saved.base;
                saved.rows.forEach(r => addRow(r.t, r.c, false));
            } else {
                addRow(25, 5, false); // Дефолт: 5 досок по 25мм
            }
            calculate();
        };
    </script>
</body>
</html>
