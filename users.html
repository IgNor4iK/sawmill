<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Управление доступом</title>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --accent: #007AFF; --green: #4CD964; --text: #ffffff; --text-dim: #888; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        .header { display: flex; align-items: center; margin-bottom: 25px; }
        .back-btn { font-size: 30px; color: var(--accent); cursor: pointer; text-decoration: none; padding-right: 20px; }
        
        .card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #222; }
        h3 { margin-top: 0; font-size: 16px; color: var(--accent); }
        
        .user-item { background: #111; padding: 10px; border-radius: 10px; margin-top: 10px; display: flex; flex-direction: column; gap: 5px; }
        .hash-str { font-family: monospace; font-size: 10px; color: #555; word-break: break-all; }
        
        input { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #333; border-radius: 10px; color: white; outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
        
        .copy-hint { font-size: 10px; color: var(--green); cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <div class="header">
        <div class="back-btn" onclick="window.history.back()">‹</div>
        <h2>Пользователи</h2>
    </div>

    <!-- ГЕНЕРАТОР -->
    <div class="card">
        <h3>Добавить нового</h3>
        <p style="font-size: 12px; color: var(--text-dim);">Введите Telegram ID нового сотрудника:</p>
        <input type="number" id="new-id" placeholder="Напр. 123456789">
        <button class="btn" onclick="generateHash()">Создать хэш</button>
        <div id="result-box" style="display:none; margin-top: 15px;">
            <p style="font-size: 11px; margin-bottom: 5px;">Хэш для config.json:</p>
            <div class="hash-str" id="new-hash" onclick="copyText(this)"></div>
            <p class="copy-hint">Нажми на хэш, чтобы скопировать</p>
        </div>
    </div>

    <!-- СПИСОК ИЗ CONFIG.JSON -->
    <div class="card">
        <h3>Текущий доступ</h3>
        <div id="users-list">Загрузка списка...</div>
    </div>

    <script>
        // Проверка прав (только админ)
        if (sessionStorage.getItem('is_admin') !== 'true') {
            window.location.href = 'index.html';
        }

        async function makeHash(id) {
            const buf = new TextEncoder().encode(id.toString());
            const hashBuf = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generateHash() {
            const id = document.getElementById('new-id').value;
            if(!id) return;
            const h = await makeHash(id);
            document.getElementById('new-hash').innerText = h;
            document.getElementById('result-box').style.display = 'block';
        }

        function copyText(el) {
            navigator.clipboard.writeText(el.innerText);
            alert("Скопировано!");
        }

        async function loadUsers() {
            const list = document.getElementById('users-list');
            try {
                const resp = await fetch('config.json?v=' + Date.now());
                const config = await resp.json();
                
                let html = '<div class="user-item"><small>Администратор:</small><div class="hash-str">' + config.admin_hash + '</div></div>';
                
                if (config.authorized_hashes && config.authorized_hashes.length > 0) {
                    html += '<p style="font-size: 12px; margin-top: 15px;">Помощники:</p>';
                    config.authorized_hashes.forEach((h, i) => {
                        html += `<div class="user-item">
                            <small>Юзер #${i+1}:</small>
                            <div class="hash-str" onclick="copyText(this)">${h}</div>
                        </div>`;
                    });
                } else {
                    html += '<p style="color:#444; font-size:12px;">Помощников пока нет.</p>';
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerText = "Ошибка загрузки config.json";
            }
        }

        loadUsers();
    </script>
</body>
</html>
