<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Управление доступом</title>
    <script src="telega.js"></script>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --accent: #007AFF; --green: #4CD964; --text: #ffffff; --text-dim: #888; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { font-size: 34px; color: var(--accent); cursor: pointer; padding-right: 15px; line-height: 1; }
        
        .card { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #222; }
        h3 { margin: 0 0 10px 0; font-size: 15px; color: var(--accent); text-transform: uppercase; }
        
        .user-item { background: #111; padding: 12px; border-radius: 12px; margin-top: 8px; border: 1px solid #222; }
        .hash-str { font-family: 'Courier New', monospace; font-size: 11px; color: #555; word-break: break-all; margin-top: 5px; cursor: pointer; }
        .hash-str:active { color: var(--green); }
        
        input { width: 100%; padding: 14px; margin: 10px 0; background: #222; border: 1px solid #333; border-radius: 12px; color: white; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--accent); }

        .btn { width: 100%; padding: 14px; background: var(--accent); border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn:active { transform: scale(0.98); }
        
        .hint { font-size: 11px; color: var(--text-dim); margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div class="back-btn" onclick="window.history.back()">‹</div>
        <h2 style="margin:0">Доступ</h2>
    </div>

    <div class="card">
        <h3>Новый сотрудник</h3>
        <p class="hint">Введи Telegram ID (цифры), чтобы получить хэш для конфига:</p>
        <input type="number" id="new-id" placeholder="ID пользователя" inputmode="numeric">
        <button class="btn" onclick="generateHash()">СФОРМИРОВАТЬ ХЭШ</button>
        
        <div id="result-box" style="display:none; margin-top: 15px;">
            <p style="font-size: 11px; color: var(--green); margin-bottom: 5px;">Нажми на код, чтобы скопировать:</p>
            <div class="hash-str" id="new-hash" onclick="copyText(this)"></div>
        </div>
    </div>

    <div class="card">
        <h3>Текущий конфиг</h3>
        <div id="users-list" style="font-size: 13px; color: #666;">Загрузка списка из config.json...</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;

        async function makeHash(id) {
            const buf = new TextEncoder().encode(id.toString());
            const hashBuf = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generateHash() {
            const idInput = document.getElementById('new-id');
            if(!idInput.value) return;
            
            tg.HapticFeedback?.impactOccurred('medium');
            const h = await makeHash(idInput.value);
            
            const hashEl = document.getElementById('new-hash');
            hashEl.innerText = `"${h}"`; // С кавычками, чтобы сразу в JSON
            document.getElementById('result-box').style.display = 'block';
        }

        function copyText(el) {
            navigator.clipboard.writeText(el.innerText.replace(/"/g, ''));
            tg.HapticFeedback?.notificationOccurred('success');
            tg.showAlert("Хэш скопирован! Теперь добавь его в authorized_hashes в файле config.json на GitHub.");
        }

        async function loadUsers() {
            const list = document.getElementById('users-list');
            try {
                const resp = await fetch('config.json?v=' + Date.now());
                if (!resp.ok) throw new Error();
                const config = await resp.json();
                
                let html = '<div style="margin-bottom:10px;"><small>АДМИН:</small><div class="hash-str">' + config.admin_hash + '</div></div>';
                
                if (config.authorized_hashes && config.authorized_hashes.length > 0) {
                    html += '<hr style="border:0; border-top:1px solid #222; margin:15px 0;"><small>ПОМОЩНИКИ:</small>';
                    config.authorized_hashes.forEach((h, i) => {
                        html += `<div class="user-item">
                            <small>Юзер #${i+1}</small>
                            <div class="hash-str" onclick="copyText(this)">${h}</div>
                        </div>`;
                    });
                } else {
                    html += '<p style="font-size:11px;">Список помощников пуст.</p>';
                }
                list.innerHTML = html;
            } catch (e) {
                list.innerText = "Ошибка доступа к config.json";
            }
        }

        window.onload = () => {
            tg.ready();
            loadUsers();
        };
    </script>
</body>
</html>
