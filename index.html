<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sawmill Debug v5.0</title>
    <style>
        :root { --bg: #0f0f0f; --card: #1a1a1a; --accent: #007AFF; --text: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; text-align: center; }
        #log { font-family: monospace; font-size: 11px; text-align: left; background: #000; padding: 10px; border-radius: 8px; margin-top: 20px; color: #0f0; overflow-y: auto; max-height: 200px; }
        .hidden { display: none; }
        .menu-item { background: var(--card); padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #333; text-decoration: none; color: white; display: block; }
    </style>
</head>
<body>

    <div id="status-box">
        <h2 id="title">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...</h2>
        <div id="log">–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...<br></div>
    </div>

    <div id="main-menu" class="hidden">
        <h1>–ü–∏–ª–æ—Ä–∞–º–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç!</h1>
        <div class="menu-grid">
            <a href="calc.html" class="menu-item">üìè –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
            <a href="journal.html" class="menu-item">üìã –ñ—É—Ä–Ω–∞–ª</a>
        </div>
    </div>

    <script>
        const logBox = document.getElementById('log');
        function logger(msg) {
            logBox.innerHTML += "> " + msg + "<br>";
            console.log(msg);
        }

        async function makeHash(id) {
            const buf = new TextEncoder().encode(id.toString());
            const hashBuf = await crypto.subtle.digest('SHA-256', buf);
            return Array.from(new Uint8Array(hashBuf)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function startApp() {
            const tg = window.Telegram.WebApp;
            logger("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞–π–¥–µ–Ω–∞. –í–µ—Ä—Å–∏—è: " + tg.version);
            
            tg.ready();
            tg.expand();

            const user = tg.initDataUnsafe?.user;
            if (!user) {
                logger("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: initData –ø—É—Å—Ç. –í—ã —Ç–æ—á–Ω–æ –≤ TG?");
                document.getElementById('title').innerText = "–û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê";
                return;
            }

            logger("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + user.first_name + " (ID: " + user.id + ")");
            
            try {
                const uHash = await makeHash(user.id);
                logger("–í–∞—à —Ö—ç—à —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω.");

                const resp = await fetch('config.json?v=' + Date.now());
                if (!resp.ok) throw new Error("–ù–µ –Ω–∞–π–¥–µ–Ω config.json (404)");
                
                const config = await resp.json();
                logger("–ö–æ–Ω—Ñ–∏–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.");

                const isAdmin = (uHash === config.admin_hash);
                const isUser = config.authorized_hashes?.includes(uHash);

                if (isAdmin || isUser) {
                    logger("–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω! –í—Ö–æ–¥–∏–º...");
                    document.getElementById('status-box').classList.add('hidden');
                    document.getElementById('main-menu').classList.remove('hidden');
                } else {
                    document.getElementById('title').innerText = "–ù–ï–¢ –î–û–°–¢–£–ü–ê";
                    logger("–•—ç—à –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö: " + uHash);
                }
            } catch (e) {
                logger("–û–®–ò–ë–ö–ê: " + e.message);
                document.getElementById('title').innerText = "–°–ë–û–ô –°–ò–°–¢–ï–ú–´";
            }
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –¢–ì
        logger("–ó–∞–≥—Ä—É–∑–∫–∞ telegram-web-app.js...");
        const script = document.createElement('script');
        script.src = "https://telegram.org";
        script.onload = () => {
            logger("–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –≤ DOM.");
            setTimeout(startApp, 200); // –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –ø—Ä–æ–≥—Ä—É–∑–∫–∏ –æ–±—ä–µ–∫—Ç–∞
        };
        script.onerror = () => logger("–ù–ï –£–î–ê–õ–û–°–¨ –°–ö–ê–ß–ê–¢–¨ –°–ö–†–ò–ü–¢ TELEGRAM!");
        document.head.appendChild(script);
    </script>
</body>
</html>
